# Python Documentation

## 1. Introduction

### **Birdsong Classification Pipeline (Python)**

The Python component of the Birdsong Classification project focuses on data preparation, model training, evaluation, and prediction using a Convolutional Neural Network (CNN). This pipeline leverages spectrograms generated by the MATLAB preprocessing stage to classify different bird species based on their vocalizations.

**Key Features:**
- **Data Handling:** Downloading, preprocessing, and organizing bird song data.
- **Modeling:** Building, training, and saving CNN models for classification.
- **Evaluation:** Assessing model performance using various metrics and visualizations.
- **Prediction:** Deploying the trained model to predict bird species from new audio samples.
- **Utilities:** Streamlined path management and visualization tools to support the workflow.

## 2. Directory Structure

```
- python/
  - setup.py
  - src/
    - birdsong_classification/
      - __init__.py
      - data/
        - dataset.py
        - download_bird_songs.py
        - prepare_data.py
        - preprocessing.py
      - evaluation/
        - evaluate.py
        - metrics.py
      - models/
        - model.py
        - train.py
      - predict.py
      - utils/
        - path_utils.py
        - visualization.py
  - birdsong_classification.egg-info/
    - dependency_links.txt
    - PKG-INFO
    - requires.txt
    - SOURCES.txt
    - top_level.txt
  - __pycache__/
  - project_structure.text
```

**Description:**
- **setup.py:** Configuration for packaging and dependencies.
- **src/birdsong_classification/:** Core Python modules for data handling, modeling, evaluation, and prediction.
- **src/birdsong_classification/data/:** Scripts for dataset management and preprocessing.
- **src/birdsong_classification/evaluation/:** Tools for model evaluation and metric calculations.
- **src/birdsong_classification/models/:** Model architecture, training, and saving/loading functionalities.
- **src/birdsong_classification/utils/:** Utility scripts for path management and visualization.
- **birdsong_classification.egg-info/:** Metadata for the Python package.


### **3. Installation and Setup**

#### **Prerequisites:**
- **Python:** Version 3.7 or higher.
- **MATLAB:** Required for prediction functionalities.
- **Packages:** Listed in `setup.py` and `requires.txt`.

#### **Setup Instructions:**

1. **Clone the Repository:**
   ```bash
   git clone https://github.com/AliBakly/Bird-Song-Classification-Using-Spectral-Analysis-and-CNNs.git
   ```

2. **Navigate to the Python Directory:**
   ```bash
   cd birdsong-classification/python
   ```

3. **Install Dependencies:**
   ```bash
   pip install -e .
   ```
   *This command installs the package in editable mode along with all required dependencies.*

4. **Install MATLAB Engine API for Python:**
   - **Locate MATLAB Engine API:**
     - Navigate to the MATLAB Engine directory, typically found at:
       ```
       <MATLAB_INSTALL_DIR>/extern/engines/python
       ```
   - **Install the Engine:**
     ```bash
     cd <MATLAB_INSTALL_DIR>/extern/engines/python
     python setup.py install
     ```
   - **Verify Installation:**
     ```python
     import matlab.engine
     ```
     *If no errors are thrown, the installation was successful.*

5. **Verify Installation:**
   ```bash
   python -m birdsong_classification.utils.path_utils
   ```
   *Ensure no errors are thrown, indicating successful installation.*

## 4. Usage Guide

### **1. Downloading Bird Songs**

Use the `download_bird_songs.py` script to download bird songs from [xeno-canto.org](https://xeno-canto.org/).

**Command:**
```bash
python -m birdsong_classification.data.download_bird_songs --species "Eurasian blue tit,House sparrow,Common chaffinch" --quality "A" --num-files 300
```

**Parameters:**
- `--species`: Comma-separated list of bird species.
- `--quality`: Recording quality (A-E).
- `--num-files`: Number of files to download per species.

### **2. Preparing and Preprocessing Data**

Preprocess the downloaded data to generate training and testing datasets.

**Command:**
```bash
python -m birdsong_classification.data.prepare_data
```

**Process Overview:**
- **Loading Data:** Loads spectrogram images and labels.
- **Splitting Data:** Divides data into training and testing sets.
- **Normalization:** Standardizes data based on training statistics.
- **Saving Processed Data:** Stores processed datasets as `.pickle` files.

### **3. Training the Model**

Train the CNN model using the preprocessed data.

**Command:**
```bash
python -m birdsong_classification.models.train
```

**Process Overview:**
- **Loading Data:** Imports training data from `data/processed/train/`.
- **Model Initialization:** Builds the CNN architecture.
- **Training:** Fits the model on training data for a specified number of epochs.
- **Saving Model:** Stores the trained model in the `models/` directory.
- **Visualization:** Generates plots for training history.

### **4. Evaluating the Model**

Assess the model's performance on the test dataset.

**Command:**
```bash
python -m birdsong_classification.evaluation.evaluate
```

**Process Overview:**
- **Loading Test Data:** Imports testing data from `data/processed/test/`.
- **Model Loading:** Retrieves the trained model from the `models/` directory.
- **Evaluation:** Computes overall accuracy and loss.
- **Per-Species Evaluation:** Calculates accuracy for each bird species.
- **Confusion Matrix:** Generates and saves a confusion matrix plot.
- **Classification Report:** Outputs detailed precision, recall, and F1 scores.

### **5. Making Predictions**

Use the trained model to predict bird species from new audio files.

**Command:**
```bash
python -m birdsong_classification.predict path/to/new_audio.mp3
```

**Process Overview:**
- **Audio Processing:** Extracts syllables and generates spectrograms using MATLAB.
- **Loading Model:** Imports the trained CNN model.
- **Prediction:** Classifies the bird species and outputs confidence scores.

## 5. Function Overview

### **1. Data Handling**

- **`dataset.py`**
  - **`BirdSongDataset` Class:** Manages loading, preprocessing, and saving of bird song spectrogram data.
  - **Key Methods:**
    - `load_data()`: Loads spectrogram images and labels.
    - `save_data()`: Saves processed datasets as pickle files.
    - `load_pickle_data()`: Retrieves data from pickle files.

- **`download_bird_songs.py`**
  - **Function:** `download_bird_songs()`
    - Downloads bird song recordings from xeno-canto.org based on specified species and quality.
  
- **`prepare_data.py`**
  - **Function:** `preprocess_data()`
    - Splits data into training and testing sets, normalizes data, and saves training statistics.

### **2. Modeling**

- **`model.py`**
  - **`BirdSongClassifier` Class:** Defines the CNN architecture for classification.
  - **Key Methods:**
    - `_build_model()`: Constructs and compiles the CNN.
    - `train()`: Trains the model on provided data.
    - `evaluate()`: Evaluates model performance on test data.
    - `predict()`: Generates predictions for new data.
    - `save()`: Saves the trained model.
    - `load()`: Loads a saved model.

- **`train.py`**
  - **Function:** `main()`
    - Orchestrates the training process, including loading data, initializing the model, training, and saving the model.

### **3. Evaluation**

- **`evaluate.py`**
  - **Function:** `main()`
    - Handles loading test data, evaluating the model, generating confusion matrices, and producing classification reports.

- **`metrics.py`**
  - **Function:** `calculate_metrics()`
    - Computes various classification metrics such as confusion matrix, accuracy, precision, recall, and F1 scores.

### **4. Prediction**

- **`predict.py`**
  - **Function:** `predict_bird_species()`
    - Processes new audio files, generates spectrograms via MATLAB, loads the trained model, and outputs predictions with confidence scores.

### **5. Utilities**

- **`path_utils.py`**
  - **Functions:**
    - `get_project_root()`: Retrieves the project's root directory.
    - `get_data_dir()`: Returns the path to the data directory.
    - `get_models_dir()`: Returns the path to the models directory.
    - `get_results_dir()`: Returns the path to the results directory.

- **`visualization.py`**
  - **`Visualizer` Class:** Provides methods for plotting training history, confusion matrices, species performance, and sample spectrograms.
  - **Key Methods:**
    - `plot_training_history()`: Visualizes loss and accuracy over epochs.
    - `plot_confusion_matrix()`: Generates a heatmap of the confusion matrix.
    - `plot_species_performance()`: Creates a bar chart of accuracy per species.
    - `plot_sample_spectrograms()`: Displays sample spectrograms with true and predicted labels.

## 6. Examples

### **Example 1: Training the Model**

**Command:**
```bash
python -m birdsong_classification.models.train
```

**Steps:**
1. **Load Data:** Imports training data from `data/processed/train/`.
2. **Initialize Model:** Builds the CNN architecture.
3. **Train Model:** Fits the model on the training data for 50 epochs.
4. **Save Model:** Stores the trained model in the `models/` directory.
5. **Generate Plots:** Creates training history plots saved in the `results/` directory.

**Expected Output:**
- Trained model saved as `birdsong_classifier.h5`.
- Training history plots (`training_history.png`) in the `results/` directory.

### **Example 2: Evaluating the Model**

**Command:**
```bash
python -m birdsong_classification.evaluation.evaluate
```

**Steps:**
1. **Load Test Data:** Imports testing data from `data/processed/test/`.
2. **Load Model:** Retrieves the trained model from `models/`.
3. **Evaluate Model:** Computes overall accuracy and loss.
4. **Per-Species Evaluation:** Assesses accuracy for each bird species.
5. **Generate Confusion Matrix:** Saves `confusion_matrix.png` in the `results/` directory.
6. **Output Classification Report:** Displays precision, recall, and F1 scores.

**Expected Output:**
- Confusion matrix plot saved as `confusion_matrix.png`.
- Classification report printed in the console.

### **Example 3: Making a Prediction**

**Command:**
```bash
python -m birdsong_classification.predict path/to/new_audio.mp3
```

**Steps:**
1. **Process Audio:** Uses MATLAB to extract syllables and generate spectrograms.
2. **Load Model:** Imports the trained CNN model.
3. **Predict Species:** Classifies the bird species and outputs confidence scores.

**Expected Output:**
- Predicted species with corresponding confidence percentages.
- Example:
  ```
  Predicted Species: Eurasian Blue Tit

  Confidence Scores:
    common_chaffinch: 10.0%
    eurasian_blue_tit: 80.0%
    house_sparrow: 10.0%
  ```

## 7. Troubleshooting

- **Error: Missing Data Directory**
  - **Description:** `FileNotFoundError` when attempting to load data.
  - **Solution:** Ensure that the `data/raw/` directory contains the necessary `.mp3` and `.jpg` files organized by species.

- **Error: Model Not Found**
  - **Description:** Unable to locate `birdsong_classifier.h5` in the `models/` directory.
  - **Solution:** Train the model using `train.py` to generate and save the model.

- **MATLAB Engine Issues in `predict.py`**
  - **Description:** MATLAB engine fails to start or execute commands.
  - **Solution:** 
    - Verify MATLAB is installed and accessible.
    - Ensure the MATLAB Engine API for Python is installed. Install it using:
      ```bash
      cd matlabroot/extern/engines/python
      python setup.py install
      ```
    - Check that the MATLAB paths in `predict.py` are correctly specified.

- **Audio Playback Issues**
  - **Description:** Errors during audio playback in the prediction phase.
  - **Solution:** Ensure MATLAB has the necessary permissions and that audio hardware is functioning correctly.

- **Dependency Installation Failures**
  - **Description:** Errors during `pip install`.
  - **Solution:** 
    - Verify Python version is 3.7 or higher.
    - Ensure `pip` is updated:
      ```bash
      pip install --upgrade pip
      ```
    - Reinstall dependencies if necessary.
